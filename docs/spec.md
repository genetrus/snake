# Snake — спецификация (MVP+)

## 1. Цель
Создать игру **«Змейка»** для **Windows**: графическое приложение с окном, отрисовкой, стабильным рендером (60+ FPS), фиксированной игровой логикой (ticks), меню/настройками, Lua-правилами и сохранением рекордов.

## 2. Технологии и ограничения
- Язык: **C++20**
- IDE: **Visual Studio 2022**
- Компилятор: **MSVC**, цель: **x64 only**
- Сборка: **CMake** (истина сборки) + генератор Visual Studio
- Зависимости: через **vcpkg (manifest mode)**, vcpkg хранится в репозитории как **submodule**: `external/vcpkg`
- Линковка зависимостей: **dynamic** (DLL рядом с exe)
- Графика: **SDL2** + **SDL_image** (PNG/JPG)
- Текст: **SDL_ttf**
- Звук: **SDL_mixer**
- Скрипты: **Lua 5.4**, `lua54.dll` лежит **рядом с `snake.exe`**
- JSON: **nlohmann-json** (через vcpkg)
- Качество: **clang-format / clang-tidy — да**
- Unit-тесты: **нет**
- CI: **GitHub Actions (Windows build) — да**

## 3. Пути данных (Assets и пользовательские файлы)
### 3.1 Assets (в репозитории/рядом с exe)
- Папка: `assets/`
- Скрипты: `assets/scripts/`
- Спрайты: `assets/sprites/` (PNG placeholder’ы)
- Звуки: `assets/sounds/` (WAV placeholder’ы)
- Шрифты: `assets/fonts/` (open-source/OFL placeholder)

### 3.2 Пользовательские файлы (AppData)
- Папка: `%AppData%/snake/`
- Файлы:
  - `%AppData%/snake/config.lua`
  - `%AppData%/snake/highscores.json`

### 3.3 Bootstrap при старте
- Если `%AppData%/snake/config.lua` отсутствует → **копировать** дефолтный из `assets/scripts/config.lua`
- Если `%AppData%/snake/highscores.json` отсутствует → **создать пустой валидный JSON**

## 4. Экран, окно, масштабирование
### 4.1 Окно
- Default: **800×800**
- Настраиваемо через настройки (Options). Применение: **сразу**.

### 4.2 Fullscreen
- Режим: **borderless fullscreen desktop** (`SDL_WINDOW_FULLSCREEN_DESKTOP`)
- Опция включения/выключения в настройках. Применение: **сразу**.

### 4.3 Tile size
- Default: **32 px**
- Настраиваемо через настройки. Применение: **сразу**.

### 4.4 Масштабирование
- Требование: допускается **дробное** масштабирование (не строго integer).
- При ресайзе применяется **filtering/letterbox** (с сохранением пропорций и полосами при необходимости).

### 4.5 UI panel
- UI панель (счёт/статусы/подсказки) располагается **вне игрового поля**.
- Позиция панели — **опция**. Default: **auto**.

## 5. Тайминг
- Игровая логика: **fixed tick**.
- Базовая частота задаётся в Lua-функции `speed_ticks_per_sec(score, config)` (ticks/sec). При ошибке Lua остаётся последнее успешное значение (фолбэк на старте — **10 tps**).
- Скорость увеличивается **по очкам** (формула задаётся в Lua), замедление применяется движком (см. §11.2 и §12.1).
- Рендер: 60+ FPS.
- VSync: **опция** в настройках.

## 6. Управление
### 6.1 Игра
- Поддержка: **стрелки + WASD**
- Две клавиши на действие: **да**
- Ограниченный набор клавиш для биндов: **стрелки, WASD, Enter, Esc, P, R**
- Клавиши по умолчанию (фиксировано):
  - `P` — Pause
  - `R` — Restart round
  - `Esc` — Menu/Exit (контекстно)
- Настройки биндов хранятся в `config.lua`.

### 6.2 Меню
- Управление меню: **мышь + клавиатура** (Enter/Esc и навигация стрелками/WASD).

### 6.3 Геймпад
- Поддержка: **нет**.

## 7. Игровое поле
- Default: **20×20**
- Настраиваемо на другие размеры (через Options). Применение изменения размера поля: **после рестарта раунда**.

## 8. Состояния игры (State Machine)
- Main Menu: Start / Options / Highscores / Exit
- Options
- Playing
- Paused (overlay)
- Game Over (экран/меню)
- Highscores (экран)

## 9. Базовые правила игры
### 9.1 Старт раунда
- Начальная длина змейки: **3**
- Рост: **+1** за обычную еду.

### 9.2 Столкновения
- Столкновение со стеной:
  - `wrap_mode = false` (режим Walls): выход за границы поля завершает раунд → **Game Over** с reason `"wall_collision"`.
  - `wrap_mode = true` (режим Wrap-around): координата головы, вышедшая за границу, заворачивается на противоположную сторону; игра продолжается.
- Самостолкновение (любой ход в клетку, уже занятую телом змейки): **Game Over** с reason `"self_collision"`.
- Настройка `wrap_mode` приходит из `config.lua` → `config.grid.wrap_mode`.

## 10. Спавн объектов
### 10.1 Обычная еда
- В состоянии **Playing** на поле всегда ровно **1** еда (гарантия движка). Если свободных клеток нет (змейка занимает всё поле) — еда временно отсутствует.
- Еда не может появляться на змейке.
- Подбор еды:
  - `score += food_score` (берётся из `config.lua`: `gameplay.food_score`, default **10**).
  - Змейка растёт на **+1** сегмент.
  - Вызывается Lua-хук `on_food_eaten(ctx)` (если определён; уведомление, ошибки логируются и игнорируются).
  - Сразу спавнится новая еда (с учётом запрета на клетки змейки).

### 10.2 Бонусы
- Типы бонусов в MVP: `bonus_score`, `bonus_slow`
- Максимум одновременно на поле: **2**
- Бонусы **не исчезают** со временем (лежат, пока не подберут).
- Бонусы не могут появляться на змейке, еде или другом бонусе.
- Политика спавна минимальная (дефолт: шанс 20% после поедания еды; тип 50/50) — будет вынесена в Lua позже; все ограничения выше соблюдаются движком.

## 11. Очки и скорость
### 11.1 Очки
- Обычная еда: `food_score` очков (`config.lua: gameplay.food_score`, default **10**; движок начисляет автоматически).
- `bonus_score`: **+50** очков (фиксированно) при подборе (не зависит от скорости/длины/уровня).

### 11.2 Ускорение
- Базовый tick rate: `speed_ticks_per_sec(score, config)` (Lua, ticks/sec).
- Эффективная скорость: `base_ticks_per_sec * 0.70` при активном slow, иначе `base_ticks_per_sec`.
- Множитель slow **не стакуется** (всегда ×0.70), при повторном подборе продлевается только таймер.
- При ошибке Lua скорость **не сбрасывается**: игра продолжает использовать последний валидный `base_ticks_per_sec` (фолбэк на старте — 10 tps).

## 12. Эффекты бонусов
### 12.1 bonus_slow
- Множитель скорости: **×0.70** (на 30% медленнее, фиксирован)
- Длительность: **6 секунд реального времени** за каждое поднятие
- Стаканье: **да, по времени** (продлевает):
  - повторный подбор во время активного slow → **+6 секунд** к оставшемуся времени
  - множитель остаётся **всегда ×0.70**, не усиливается; итоговый tick rate = базовый Lua rate × 0.70, пока таймер > 0

### 12.2 Рост змейки от бонусов
- `bonus_score` и `bonus_slow` **НЕ** увеличивают длину змейки.

## 18. Snake (grid coordinates)
- Координаты змейки хранятся в **клетках** поля (`x`, `y`), а не в пикселях.
- Старт/рестарт раунда:
  - длина = **3**;
  - направление = **вправо**;
  - размещение по центру поля по клеткам: голова `(W/2, H/2)`, далее `(W/2-1, H/2)`, хвост `(W/2-2, H/2)` (для малых полей координаты **клампятся** в границах).
- Изменение направления **не** допускает разворот на 180° за один шаг (противоположный ввод игнорируется).

## 13. Lua: зона ответственности и хуки
### 13.1 Где лежат скрипты
- `assets/scripts/` (в репозитории/рядом с exe)
- Активная конфигурация пользователя: `%AppData%/snake/config.lua`

### 13.2 Роль Lua
Lua задаёт/обрабатывает:
- правила столкновений (Walls/Wrap) — как правило/реакции
- формулу ускорения
- спавн еды/бонусов (политика), при соблюдении ограничений движка
- подсчёт очков (параметры/настройки)
- размеры поля/параметры (через config)
- меню/настройки: **данные + реакции на изменения**, UI рисуется в C++

### 13.3 Вызовы (hooks) из C++ в Lua
Минимальный набор:
- `on_init(ctx)`
- `on_tick(ctx)`
- `on_round_start(ctx)` — при старте/рестарте раунда
- `on_food_eaten(ctx)`
- `on_bonus_picked(ctx, type)` — `type` строго `"bonus_score"` или `"bonus_slow"`
- `on_bonus_picked(ctx, type)`
- `on_game_over(ctx, reason)`
- `on_setting_changed(ctx, key, value)`

### State machine / Screens
- Экранов шесть: **MainMenu**, **Options**, **Highscores**, **Playing**, **Paused** (оверлей), **GameOver**.
- Переходы: Start в меню запускает Playing; Options/Highscores выходят в меню по Esc; в Playing клавиша **P** ставит игру на паузу (**Paused**), повторное **P** возвращает; **Esc** из Playing/Paused ведёт в меню; столкновение переводит в GameOver; на GameOver **Enter/R** рестартят раунд и возвращают в Playing, **Esc** — в меню.
- Тики игрового мира идут **только в Playing**; Paused рисует оверлей без тиков.
- Настройки, требующие рестарта раунда (board size / wrap), применяются при рестарте (R/Enter) после отметки pending.
- При входе в GameOver текущий счёт добавляется в таблицу рекордов и сохраняется; экран Highscores показывает сохранённые записи.

## 14. Hot reload Lua
- Клавиша: **F5**
- Работает **везде** (в меню, в игре, в паузе, в Game Over).
- При ошибке загрузки/выполнения нового скрипта:
  - остаёмся на **старой** рабочей версии Lua
  - показываем ошибку пользователю (overlay/сообщение)

## 15. Настройки (Options) и сохранение
- Настройки хранятся в `%AppData%/snake/config.lua`
- Изменения в Options **сохраняются сразу при каждом изменении**
- Любое изменение в Options **немедленно** сохраняется: `%AppData%/snake/config.lua` записывается после каждого изменения
- Применение:
  - поле (board size) — **после рестарта раунда**
  - tile size — **сразу**
  - размер окна — **сразу**
  - fullscreen — **сразу**
  - VSync — **опция**, применяется через реализацию (допускается пересоздание renderer)
    - переключение VSync реализовано через пересоздание `SDL_Renderer` с перезагрузкой текстур/шрифтов

## Applying settings
- Apply on restart: `grid.board_w`, `grid.board_h`, `grid.wrap_mode`.
- Apply immediately: `grid.tile_size`, `window.width`, `window.height`, `window.fullscreen_desktop`, `window.vsync`.
- Note: `window.vsync` is applied by recreating `SDL_Renderer`; on failure the value is reverted.

## 16. Highscores
- Top: **10** записей
- Место хранения: `%AppData%/snake/highscores.json`
- JSON поля записи:
  - `name` (string)
  - `score` (int)
  - `achieved_at` (timestamp, **ISO-8601 строка в UTC**, например `2026-01-05T18:55:00Z`)

### 16.1 Ввод имени
- Ввод имени показывается при попадании в Top-10.
- Разрешённые символы:
  - латиница: `A–Z`, `a–z`
  - цифры: `0–9`
  - опционально: пробел (ASCII space)
  - символы: `_` и `-`
- Длина: **1–12** символов

## 17. Анимации и звук (MVP)
### 17.1 Анимации
- Еда: пульсация/кадрирование
- Змейка: повороты/скольжение
- Game Over / меню: анимация переходов/элементов

### 17.2 Звук (WAV)
События со звуком:
- еда съедена
- Game Over
- кнопки меню
- пауза
- снятие паузы
