# Snake — спецификация (MVP+)

## 1. Цель
Создать игру **«Змейка»** для **Windows**: графическое приложение с окном, отрисовкой, стабильным рендером (60+ FPS), фиксированной игровой логикой (ticks), меню/настройками, Lua-правилами и сохранением рекордов.

## 2. Технологии и ограничения
- Язык: **C++20**
- IDE: **Visual Studio 2022**
- Компилятор: **MSVC**, цель: **x64 only**
- Сборка: **CMake** (истина сборки) + генератор Visual Studio
- Зависимости: через **vcpkg (manifest mode)**, vcpkg хранится в репозитории как **submodule**: `external/vcpkg`
- Линковка зависимостей: **dynamic** (DLL рядом с exe)
- Графика: **SDL2** + **SDL_image** (PNG/JPG)
- Текст: **SDL_ttf**
- Звук: **SDL_mixer**
- Скрипты: **Lua 5.4**, `lua54.dll` лежит **рядом с `snake.exe`**
- JSON: **nlohmann-json** (через vcpkg)
- Качество: **clang-format / clang-tidy — да**
- Unit-тесты: **нет**
- CI: **GitHub Actions (Windows build) — да**

## 3. Пути данных (Assets и пользовательские файлы)
### 3.1 Assets (в репозитории/рядом с exe)
- Папка: `assets/`
- Скрипты: `assets/scripts/`
- Спрайты: `assets/sprites/` (PNG placeholder’ы)
- Звуки: `assets/sounds/` (WAV placeholder’ы)
- Шрифты: `assets/fonts/` (open-source/OFL placeholder)

### 3.2 Пользовательские файлы (AppData)
- Папка: `%AppData%/snake/`
- Файлы:
  - `%AppData%/snake/config.lua`
  - `%AppData%/snake/highscores.json`

### 3.3 Bootstrap при старте
- Если `%AppData%/snake/config.lua` отсутствует → **копировать** дефолтный из `assets/scripts/config.lua`
- Если `%AppData%/snake/highscores.json` отсутствует → **создать пустой валидный JSON**

## 4. Экран, окно, масштабирование
### 4.1 Окно
- Default: **800×800**
- Настраиваемо через настройки (Options). Применение: **сразу**.

### 4.2 Fullscreen
- Режим: **borderless fullscreen desktop** (`SDL_WINDOW_FULLSCREEN_DESKTOP`)
- Опция включения/выключения в настройках. Применение: **сразу**.

### 4.3 Tile size
- Default: **32 px**
- Настраиваемо через настройки. Применение: **сразу**.

### 4.4 Масштабирование
- Требование: допускается **дробное** масштабирование (не строго integer).
- При ресайзе применяется **filtering/letterbox** (с сохранением пропорций и полосами при необходимости).

### 4.5 UI panel
- UI панель (счёт/статусы/подсказки) располагается **вне игрового поля**.
- Позиция панели — **опция**. Default: **auto**.

## 5. Тайминг
- Игровая логика: **fixed tick**.
- Базовая частота: **10 шагов/сек** (до ускорения).
- Скорость увеличивается **по очкам** (формула задаётся в Lua).
- Рендер: 60+ FPS.
- VSync: **опция** в настройках.

## 6. Управление
### 6.1 Игра
- Поддержка: **стрелки + WASD**
- Две клавиши на действие: **да**
- Ограниченный набор клавиш для биндов: **стрелки, WASD, Enter, Esc, P, R**
- Клавиши по умолчанию (фиксировано):
  - `P` — Pause
  - `R` — Restart round
  - `Esc` — Menu/Exit (контекстно)
- Настройки биндов хранятся в `config.lua`.

### 6.2 Меню
- Управление меню: **мышь + клавиатура** (Enter/Esc и навигация стрелками/WASD).

### 6.3 Геймпад
- Поддержка: **нет**.

## 7. Игровое поле
- Default: **20×20**
- Настраиваемо на другие размеры (через Options). Применение изменения размера поля: **после рестарта раунда**.

## 8. Состояния игры (State Machine)
- Main Menu: Start / Options / Highscores / Exit
- Options
- Playing
- Paused (overlay)
- Game Over (экран/меню)
- Highscores (экран)

## 9. Базовые правила игры
### 9.1 Старт раунда
- Начальная длина змейки: **3**
- Рост: **+1** за обычную еду.

### 9.2 Столкновения
- Самостолкновение (змейка врезалась в себя): **Game Over**
- Границы поля: режим выбирается настройкой:
  - **Walls**: удар о стену → **Game Over**
  - **Wrap-around**: выход за границу переносит на противоположный край
- Режим Walls/Wrap — **переключаемая опция** в настройках.

## 10. Спавн объектов
### 10.1 Обычная еда
- На поле всегда ровно **1** еда (гарантия движка).
- Еда не может появляться на змейке.

### 10.2 Бонусы
- Типы бонусов в MVP: `bonus_score`, `bonus_slow`
- Максимум одновременно на поле: **2**
- Бонусы **не исчезают** со временем (лежат, пока не подберут).
- Бонусы не могут появляться на змейке.

## 11. Очки и скорость
### 11.1 Очки
- Обычная еда: **+10** очков (фиксированно), значение хранится в Lua как настройка.
- `bonus_score`: **+50** очков (фиксированно) при подборе (не зависит от скорости/длины/уровня).

### 11.2 Ускорение
- Скорость растёт **по очкам** (точная формула в Lua).

## 12. Эффекты бонусов
### 12.1 bonus_slow
- Множитель скорости: **×0.70** (на 30% медленнее)
- Длительность: **6 секунд реального времени**
- Стаканье: **да, по времени** (продлевает):
  - повторный подбор во время активного slow → **+6 секунд** к оставшемуся времени
  - множитель остаётся **всегда ×0.70**, не усиливается

### 12.2 Рост змейки от бонусов
- `bonus_score` и `bonus_slow` **НЕ** увеличивают длину змейки.

## 13. Lua: зона ответственности и хуки
### 13.1 Где лежат скрипты
- `assets/scripts/` (в репозитории/рядом с exe)
- Активная конфигурация пользователя: `%AppData%/snake/config.lua`

### 13.2 Роль Lua
Lua задаёт/обрабатывает:
- правила столкновений (Walls/Wrap) — как правило/реакции
- формулу ускорения
- спавн еды/бонусов (политика), при соблюдении ограничений движка
- подсчёт очков (параметры/настройки)
- размеры поля/параметры (через config)
- меню/настройки: **данные + реакции на изменения**, UI рисуется в C++

### 13.3 Вызовы (hooks) из C++ в Lua
Минимальный набор:
- `on_init(ctx)`
- `on_tick(ctx)`
- `on_round_start(ctx)` — при старте/рестарте раунда
- `on_food_eaten(ctx)`
- `on_bonus_picked(ctx, type)`
- `on_game_over(ctx, reason)`
- `on_setting_changed(ctx, key, value)`

## 14. Hot reload Lua
- Клавиша: **F5**
- Работает **везде** (в меню, в игре, в паузе, в Game Over).
- При ошибке загрузки/выполнения нового скрипта:
  - остаёмся на **старой** рабочей версии Lua
  - показываем ошибку пользователю (overlay/сообщение)

## 15. Настройки (Options) и сохранение
- Настройки хранятся в `%AppData%/snake/config.lua`
- Изменения в Options **сохраняются сразу при каждом изменении**
- Применение:
  - поле (board size) — **после рестарта раунда**
  - tile size — **сразу**
  - размер окна — **сразу**
  - fullscreen — **сразу**
  - VSync — **опция**, применяется через реализацию (допускается пересоздание renderer)
    - переключение VSync реализовано через пересоздание `SDL_Renderer` с перезагрузкой текстур/шрифтов

## 16. Highscores
- Top: **10** записей
- Место хранения: `%AppData%/snake/highscores.json`
- JSON поля записи:
  - `name` (string)
  - `score` (int)
  - `achieved_at` (timestamp, **ISO-8601 строка в UTC**, например `2026-01-05T18:55:00Z`)

### 16.1 Ввод имени
- Ввод имени показывается при попадании в Top-10.
- Разрешённые символы:
  - латиница: `A–Z`, `a–z`
  - цифры: `0–9`
  - опционально: пробел (ASCII space)
  - символы: `_` и `-`
- Длина: **1–12** символов

## 17. Анимации и звук (MVP)
### 17.1 Анимации
- Еда: пульсация/кадрирование
- Змейка: повороты/скольжение
- Game Over / меню: анимация переходов/элементов

### 17.2 Звук (WAV)
События со звуком:
- еда съедена
- Game Over
- кнопки меню
- пауза
- снятие паузы
